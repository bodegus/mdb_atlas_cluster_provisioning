# MongoDB Atlas Cluster Provisioning - Project Documentation

## Project Overview
This project provides Terraform-based implementations for deploying MongoDB Atlas clusters across multiple environments (dev, nonprod, prod) using standardized modules.

## Directory Structure
```
Root/
├── deploy_basic_cluster/        # Basic cluster deployment example
│   ├── terraform/               # Terraform configuration
│   │   ├── main.tf             # Main cluster configuration
│   │   ├── variables.tf        # Input variable definitions
│   │   └── outputs.tf          # Output definitions
│   ├── dev.tfvars              # Dev environment variables
│   ├── nonprod.tfvars          # Non-prod environment variables
│   └── prod.tfvars             # Production environment variables
├── deploy_module_of_modules/    # Module-based deployment example
├── deploy_three_cluster_types/  # Three cluster types example
├── deploy_verbose_cluster/      # Verbose cluster configuration example
├── module_examples/             # Reference module implementations
│   ├── 01_single_region/       # Single region cluster
│   ├── 02_single_region_sharded/# Single region sharded cluster
│   ├── 03_single_region_with_analytics/
│   ├── 04_multi_region_single_geo/
│   ├── 05_multi_region_multi_geo/
│   ├── 06_multi_geo_zone_sharded/
│   ├── 07_multi_cloud/
│   ├── 08_dev/
│   ├── 09_replication_var/
│   ├── 10_multi_shard_multi_geo/
│   ├── 11_migration_replica_to_sharded/
│   ├── 99_test_ip_import/
│   └── tf_*.sh                  # Module example scripts
└── scripts/                     # Centralized deployment automation
    ├── tf_init.sh              # Initialize Terraform with environment-specific backend
    ├── tf_plan.sh              # Run terraform plan for PR validation
    ├── tf_apply.sh             # Apply terraform changes on main branch
    ├── tf_destroy.sh           # Destroy terraform resources
    └── validate_apply.sh       # Validation script for PR checks
```

## Key Patterns

### 1. Module Usage
Deployment examples use the MongoDB Atlas cluster module from:
- Repository: `terraform-mongodbatlas-modules/terraform-mongodbatlas-cluster` (GitHub)
- Uses the main branch of the official MongoDB Atlas Terraform module

Module examples demonstrate direct usage patterns for various cluster configurations.

### 2. Secret Management
Based on patterns from the reference repository:
- MongoDB Atlas API keys stored in AWS SSM Parameter Store
- Hierarchical parameter naming: `/{project}/{env}/mongodb/{param_type}`
- Terraform accesses secrets via data sources

### 3. Backend Configuration
- S3 backend with environment-specific state files
- Backend configuration auto-generated by scripts based on environment
- Pattern: `s3://{bucket}/{project}/{example}/{env}/terraform.tfstate`

### 4. Environment Strategy
- Three environments: dev, nonprod, prod
- Each environment has its own:
  - MongoDB Atlas Organization
  - AWS account/profile
  - State file
  - Variable file (tfvars)

## Script Usage

Scripts are run from deployment directories with the environment as an argument:

```bash
# From deploy_*/ directories (e.g., deploy_basic_cluster/):
../scripts/tf_init.sh dev
../scripts/tf_plan.sh nonprod
../scripts/tf_apply.sh prod
../scripts/tf_destroy.sh dev

# For module examples:
cd module_examples/
./tf_init.sh <example_number>
./tf_plan.sh <example_number>
./tf_apply.sh <example_number>
./tf_destroy.sh <example_number>
```

### Scripts Behavior:
- **tf_init.sh**: Initializes Terraform with environment-specific backend configuration
- **tf_plan.sh**: Runs terraform plan (typically for PR validation)
- **tf_apply.sh**: Applies terraform changes (typically after merge to main)
- **tf_destroy.sh**: Destroys all resources (with confirmation prompt)

## MongoDB Atlas Provider Configuration
The provider requires:
- Public API key (from SSM)
- Private API key (from SSM)
- Organization ID (environment-specific)

## Security Considerations
- Never commit API keys or secrets
- Use AWS SSM for all sensitive data
- Follow least-privilege IAM policies
- Use lifecycle rules to prevent accidental secret exposure

## Project Structure Types

### Deployment Examples (`deploy_*`)
Production-ready deployment configurations with full environment support:
1. **deploy_basic_cluster**: Simple cluster deployment
2. **deploy_module_of_modules**: Demonstrates module composition patterns
3. **deploy_three_cluster_types**: Shows different cluster type configurations
4. **deploy_verbose_cluster**: Comprehensive configuration example with all options

### Module Examples (`module_examples/`)
Reference implementations showing specific cluster patterns:
- **01-11**: Numbered examples covering various deployment scenarios
- **99_test_ip_import**: Special test configuration
- Each contains `main.tf`, `variables.tf`, and `versions.tf`
- No environment-specific tfvars (designed for testing/learning)

## Adding New Deployments
### For Production Deployments:
1. Copy one of the `deploy_*` directory structures
2. Customize the terraform configuration
3. Update tfvars files for each environment (dev, nonprod, prod)
4. Run scripts from the new deployment directory

### For Module Examples:
1. Copy an existing numbered example from `module_examples/`
2. Modify the configuration to demonstrate your pattern
3. Use the module example scripts for testing

## Dependencies
- Terraform >= 1.6
- AWS CLI configured with appropriate profiles
- MongoDB Atlas API keys stored in SSM
- Access to target MongoDB Organizations
- GitHub CLI installed and authenticated: `brew install gh && gh auth login`

## GitHub Actions

### Automatic Validation
The repository includes automatic validation that runs on every push:
- **Workflow**: `mongodb-cluster-validation.yml`
- **Trigger**: Push to any branch affecting `deploy_**` directories
- **Action**: Automatically discovers all `deploy_*` directories and validates their configurations
- **Matrix**: Dynamically builds a test matrix from found deployments and environments
- **Validation**: Uses 30-second timeout to verify MongoDB Atlas API acceptance

### Manual Deployment
Use GitHub CLI (`gh`) to trigger MongoDB Atlas cluster deployment workflows:

### Manual Deployment Commands
```bash
# Plan changes for dev environment
gh workflow run mongodb-cluster-deploy.yml \
  --field environment=dev \
  --field action=plan

# Apply changes for dev environment
gh workflow run mongodb-cluster-deploy.yml \
  --field environment=dev \
  --field action=apply

# Plan for nonprod environment
gh workflow run mongodb-cluster-deploy.yml \
  --field environment=nonprod \
  --field action=plan

# Apply for nonprod environment
gh workflow run mongodb-cluster-deploy.yml \
  --field environment=nonprod \
  --field action=apply

# Plan for prod environment
gh workflow run mongodb-cluster-deploy.yml \
  --field environment=prod \
  --field action=plan

# Apply for prod environment
gh workflow run mongodb-cluster-deploy.yml \
  --field environment=prod \
  --field action=apply

# Destroy resources (use with caution!)
gh workflow run mongodb-cluster-deploy.yml \
  --field environment=dev \
  --field action=destroy
```

### Monitor Workflow Runs
```bash
# List recent workflow runs (validation)
gh run list --workflow=mongodb-cluster-validation.yml

# List recent workflow runs (deployment)
gh run list --workflow=mongodb-cluster-deploy.yml

# Watch the latest run in real-time
gh run watch

# View a specific run
gh run view <run-id>

# View logs for a specific run
gh run view <run-id> --log

# Re-run a failed workflow
gh run rerun <run-id>

# Cancel a running workflow
gh run cancel <run-id>
```

### Check Workflow Status
```bash
# Get status of the latest validation run
gh run list --workflow=mongodb-cluster-validation.yml --limit 1

# Get status of the latest deployment run
gh run list --workflow=mongodb-cluster-deploy.yml --limit 1

# Get all runs for a specific environment (using jq)
gh run list --workflow=mongodb-cluster-deploy.yml --json displayTitle,status,conclusion | \
  jq '.[] | select(.displayTitle | contains("dev"))'

# Get runs with specific status
gh run list --workflow=mongodb-cluster-validation.yml --status failure
gh run list --workflow=mongodb-cluster-deploy.yml --status in_progress
gh run list --workflow=mongodb-cluster-deploy.yml --status completed
```
